<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="pigpio.html">pigpio</a><ul class='methods'><li data-type='method'><a href="pigpio.html#close">close</a></li><li data-type='method'><a href="pigpio.html#getHardwareRevision">getHardwareRevision</a></li><li data-type='method'><a href="pigpio.html#pi">pi</a></li><li data-type='method'><a href="pigpio.html#setPwmDutycycle">setPwmDutycycle</a></li><li data-type='method'><a href="pigpio.html#setServoPulsewidth">setServoPulsewidth</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#define">define</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const def = require('./definitions.js');
const net = require('net');
const assert = require('assert');
const Put = require('put');
const reverse_string = require('./utils.js').reverse_string;

const _LOCKS = [];

/** @class */
function pigpio() {
    /* no-empty-function */
}

/**
 *
 * Connects to the pigpio daemon.
 *
 * This method has to be called before it's possible to do anything with
 * the GPIO pins.
 *
 * The callback will be called when the connection has been established or
 * if an error occurs.
 *
 * @param {string} [host] - The host to connect to.
 * @param {number} [port] - The port on the host to connect to.
 * @param {Object} [cb] - Callback function.
 */
pigpio.prototype.pi = function(host, port, cb) {
    const that = this;
    if (host === undefined) {
        host = process.env.PIGPIO_ADDR || 'localhost';
    }
    if (port === undefined) {
        port =  process.env.PIGPIO_PORT || '8888';
    }
    this.client = net.connect({host, port});

    this.client.on('connect', () => {
        // Disable the Nagle algoritm
        this.client.setNoDelay(true);

        cb();
    });
    this.client.on("data", (data) => {
        that._releaseLock();
        if (that._next !== undefined) {
            that._next(undefined, reverse_string(data.toString('hex')));
        }

    });

    this.client.on('error', (e) => {
        cb(e);
    });
};

/**
 * Half-closes the connection. We might still get some data from the server.
 */
pigpio.prototype.close = function() {
    this.client.end();
};

/**
 *
 * Starts (500-2500) or stops (0) servo pulses on the given gpio pin.
 *
 * The selected pulsewidth will continue to be transmitted until
 * changed by a subsequent call to set_servo_pulsewidth.
 *
 * The pulsewidths supported by servos varies and should probably
 * be determined by experiment. A value of 1500 should always be
 * safe and represents the mid-point of rotation.
 *
 * You can DAMAGE a servo if you command it to move beyond its
 * limits.
 *
 * @example
 *     gpio.setServoPulsewidth(17, 0)    # off
 *     gpio.setServoPulsewidth(17, 1000) # safe anti-clockwise
 *     gpio.setServoPulsewidth(17, 1500) # centre
 *     gpio.setServoPulsewidth(17, 2000) # safe clockwise
 *
 * @param {number} userGpio - The number of the gpio to address. 0-31.
 * @param {number} pulseWidth - The servo pulsewidth to generate
 *              0 (off),
 *              500 (most anti-clockwise) - 2500 (most clockwise).
 */
pigpio.prototype.setServoPulsewidth = function(userGpio, pulseWidth) {
    assert(userGpio>=0 &amp;&amp; userGpio &lt;=31, "userGpio must be in the range 0-31");
    assert(pulseWidth>=0 &amp;&amp; pulseWidth &lt;=2500, "pulsWidth must be in the range 0-255");
    this._pi_gpio_command(def.PI_CMD_SERVO, userGpio, pulseWidth);
};

/**
 * Starts (non-zero dutycycle) or stops (0) PWM pulses on the gpio.
 *
 * @example
 *     pi.set_PWM_dutycycle(4,   0) # PWM off
 *     pi.set_PWM_dutycycle(4,  64) # PWM 1/4 on
 *     pi.set_PWM_dutycycle(4, 128) # PWM 1/2 on
 *     pi.set_PWM_dutycycle(4, 192) # PWM 3/4 on
 *     pi.set_PWM_dutycycle(4, 255) # PWM full on
 *
 * @param {number} userGpio - The number of the gpio to address (0-31).
 * @param {number} dutycycle - The pwm dutycycle to use:
 *              0 (off),
 *              255 (full on).
 */
pigpio.prototype.setPwmDutycycle = function(userGpio, dutycycle) {
    assert(userGpio>=0 &amp;&amp; userGpio &lt;=31, "userGpio must be in the range 0-31");
    assert(dutycycle>=0 &amp;&amp; dutycycle &lt;=255, "dutycycle must be in the range 0-255");
    this._pi_gpio_command(def.PI_CMD_PWM, userGpio, dutycycle);
};


/**
 *
 * Returns the Pi's hardware revision number.
 *
 * The hardware revision is the last few characters on the Revision line of /proc/cpuinfo.
 * The revision number can be used to determine the assignment of GPIO to pins (see [*gpio*]).
 * There are at least three types of board.
 * * Type 1 boards have hardware revision numbers of 2 and 3.
 * * Type 2 boards have hardware revision numbers of 4, 5, 6, and 15.
 * * Type 3 boards have hardware revision numbers of 16 or greater.
 * * If the hardware revision can not be found or is not a valid hexadecimal number the function returns 0.
 *
 * @param {callback} cb - Callback that will receive the result in form of function (err, data).
 */
pigpio.prototype.getHardwareRevision = function(cb) {
    this._pi_gpio_command(def.PI_CMD_HWVER, 0, 0, cb, true);

};

pigpio.prototype._pi_gpio_command = function(command, parameter1, parameter2, next, wait_for_response) {
    const cmd = Put()
        .word32le(command)
        .word32le(parameter1)
        .word32le(parameter2)
        .word32le(0);
    this._acquireLock();
    if(!this.client.write(cmd.buffer())) {
        next(new Error("Error Sending Command to Pi: "+command));
    }
    if(wait_for_response) {
        this._next = next;
    } else {
        this._releaseLock();
        if( next !== undefined) {
            next();
        }
    }
};

pigpio.prototype._acquireLock = function () {
    if (_LOCKS[this.host+':'+this.port] === undefined) {
        _LOCKS[this.host+':'+this.port] = 'Locked';
    } else {
        throw new Error ('Can not acquire Lock');
    }
};

pigpio.prototype._releaseLock = function () {
    if (_LOCKS[this.host+':'+this.port] !== undefined) {
        _LOCKS[this.host+':'+this.port] = undefined;
    }
};

module.exports = pigpio;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sun Jan 08 2017 18:40:34 GMT+0000 (GMT) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
